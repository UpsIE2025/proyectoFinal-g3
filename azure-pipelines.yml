trigger:
- main  # Ajusta si tu rama principal tiene otro nombre

resources:
  repositories:
    - repository: micro_producer
      type: git
      name: Patrones IE/micro_producer
    - repository: micro_consumer
      type: git
      name: Patrones IE/micro_consumer

pool:
  name: PatronesIE  # ğŸ‘‰ Usando tu agente Docker auto-hospedado

variables:
  imageRepositoryProducer: 'micro_producer'
  imageRepositoryConsumer: 'micro_consumer'
  tag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Construir imÃ¡genes Docker'
  jobs:
  - job: Build
    displayName: 'ConstrucciÃ³n de microservicios'
    workspace:
      clean: all
    steps:
    - checkout: self
    - checkout: micro_producer
    - checkout: micro_consumer

    # âœ… ğŸ‘‰ Asignamos permisos, configuramos UTF-8 y limpiamos cachÃ© Maven
    - script: |
        echo "ğŸ”§ Configurando entorno para UTF-8 y limpieza de cachÃ© Maven..."
        export MAVEN_OPTS="-Dfile.encoding=UTF-8"
        rm -rf ~/.m2/repository

        echo "ğŸ”§ Dando permisos de ejecuciÃ³n al wrapper de Maven..."
        chmod +x $(Build.SourcesDirectory)/micro_producer/mvnw
        chmod +x $(Build.SourcesDirectory)/micro_consumer/mvnw

        echo "ğŸ” Verificando codificaciÃ³n de application.properties..."
        file -i $(Build.SourcesDirectory)/micro_producer/src/main/resources/application.properties
        iconv -f ISO-8859-1 -t UTF-8 $(Build.SourcesDirectory)/micro_producer/src/main/resources/application.properties -o $(Build.SourcesDirectory)/micro_producer/src/main/resources/application.properties || true

        echo "ğŸ”§ Compilando micro_producer con codificaciÃ³n UTF-8 explÃ­cita..."
        cd $(Build.SourcesDirectory)/micro_producer
        ./mvnw clean package -DskipTests -e

        echo "ğŸ”§ Compilando micro_consumer con codificaciÃ³n UTF-8 explÃ­cita..."
        cd $(Build.SourcesDirectory)/micro_consumer
        ./mvnw clean package -DskipTests -e
      displayName: 'ğŸ—ï¸ CompilaciÃ³n de microservicios (Maven) con UTF-8 y limpieza'

    # âœ… ğŸ‘‰ Construimos las imÃ¡genes Docker ahora que los .war existen
    - script: |
        echo "ğŸ”¨ Construyendo imagen del microservicio Producer (uso de imÃ¡genes locales)..."
        docker build -t micro_producer:$(tag) $(Build.SourcesDirectory)/micro_producer

        echo "ğŸ”¨ Construyendo imagen del microservicio Consumer (uso de imÃ¡genes locales)..."
        docker build -t micro_consumer:$(tag) $(Build.SourcesDirectory)/micro_consumer

        echo "ğŸ” Verificando imÃ¡genes generadas..."
        docker images

        echo "ğŸ” Tag generado para las imÃ¡genes: $(tag)"
      displayName: 'ğŸ³ ConstrucciÃ³n y verificaciÃ³n de imÃ¡genes Docker locales'

- stage: Deploy
  displayName: 'Desplegar con Docker Compose (ImÃ¡genes Locales)'
  dependsOn: Build
  jobs:
  - job: Deploy
    displayName: 'Despliegue con docker-compose (usando imÃ¡genes locales)'
    workspace:
      clean: all
    steps:
    - checkout: self
    - script: |
        echo "ğŸš€ Iniciando despliegue con docker-compose usando imÃ¡genes locales..."
        cd $(Build.SourcesDirectory)
        docker-compose down || true
        docker-compose up -d --build

        echo "ğŸ”„ Verificando estado de los contenedores..."
        docker ps -a
      displayName: 'ğŸ›ï¸ Levantar servicios con docker-compose usando imÃ¡genes locales'
